# Fabric Accessible Graphics Toolkit - Project Context

## Project Purpose

This is a command-line toolkit for converting visual images (floor plans, architectural drawings, sketches, photographs) into tactile-ready formats for PIAF (Picture In A Flash) machines. PIAF machines create raised tactile graphics on special swell paper, making visual content accessible to blind and low-vision users.

**Primary User:** A blind/low-vision architecture student who needs to access visual course materials and create tactile versions of their design work.

## Core Design Principle

**Accessibility First**: Every aspect of this toolkit is designed for screen-reader compatibility and non-visual operation. No visual inspection should be required to use it successfully.

## Current Status: Phase 3 Complete - Production Ready (Updated Jan 7, 2026)

**Latest:** Auto-scaling and abbreviation key features added to handle Braille labels larger than original text bounding boxes. See Jan 7, 2026 session notes below.

**READ FIRST:** See `docs/development/BRAILLE_STATUS.md` for complete current status and recent fixes.

### Phase 1 (Complete)

**Core Functionality:**
- Image loading and validation (supports JPG, PNG, TIFF, BMP, GIF, PDF)
- Grayscale conversion
- Threshold-based black/white conversion
- Automatic density checking (prevents paper over-swelling)
- PDF generation at 300 DPI
- Paper size support (Letter 8.5x11", Tabloid 11x17")

**Accessibility Features:**
- Screen-reader friendly CLI with Click framework
- Clear, descriptive status messages (no emojis or visual-only symbols)
- Verbose mode for detailed progress
- Interactive mode with step-by-step prompts
- Consistent message formatting: `[STATUS]: [Message]`
- Real-time output (no buffering)
- Error messages with suggested solutions

**Configuration:**
- YAML-based tactile standards configuration
- Configurable thresholds and density limits
- Extensible for future pattern definitions

### Phase 2 - Implemented Features

**‚úÖ Contrast Enhancement (Complete)**
- S-curve enhancement (like Photoshop curves) with adjustable strength
- Auto-contrast (histogram stretching)
- CLAHE (Contrast Limited Adaptive Histogram Equalization)
- Histogram equalization
- CLI options: `--enhance s_curve|auto_contrast|clahe|histogram` and `--enhance-strength 0.0-2.0`

**‚úÖ Preset System (Complete)**
- 10 predefined presets for common image types
- Presets: floor_plan, sketch, photograph, elevation, section, diagram, site_plan, detail_drawing, technical_drawing, presentation
- CLI option: `--preset PRESET_NAME`
- Command: `fabric-access list-presets` to see all available presets
- Each preset has optimized threshold, enhancement, and paper size settings

**‚úÖ Batch Processing (Complete)**
- Process entire directories of images
- Recursive subdirectory support
- File pattern filtering (e.g., *.jpg, *.png)
- Apply presets or custom settings to all files
- Progress tracking and summary reporting
- Command: `fabric-access batch INPUT_DIR OUTPUT_DIR --preset PRESET_NAME`

### Phase 2 - Complete Features

**‚úÖ Image Tiling (Complete)**
- Auto-detect when images exceed paper size
- Split large images into overlapping tiles
- Add registration marks for assembly
- Multi-page PDF output with tile labels
- Essential for drawings larger than 11x17"

**‚úÖ Automatic Density Reduction (Complete)**
- Morphological erosion to reduce density
- Iterative reduction to target density
- Automatically fix images that would over-swell
- CLI: `--auto-reduce-density --target-density 0.30`

### Phase 3 - Complete Features (Dec 2025)

**‚úÖ Text Detection (Complete)**
- Tesseract OCR 5.3.4 integration
- Detects text and architectural dimensions
- Pattern matching for feet-inches, meters, mm, cm
- CLI: `--detect-text`

**‚úÖ Braille Conversion (Complete)**
- liblouis 3.29.0 for professional translation
- Grade 1 (uncontracted) and Grade 2 (contracted) support
- Unicode Braille output (U+2800-U+28FF)
- Proper rendering with DejaVu Sans font
- Fallback ASCII-to-Braille converter
- CLI: `--braille-grade 1|2`

**‚úÖ PDF Font Integration (Fixed Dec 17, 2025)**
- DejaVu Sans TrueType font registration
- Braille characters render as dots (not black squares)
- Cross-platform font path detection
- Graceful fallback to Helvetica

**üî≤ Pattern Detection & Simplification (Future)**
- Detect architectural hatching patterns (brick, concrete, earth, etc.)
- Simplify patterns for tactile output
- Planned for Phase 4

## Project Structure

```
fabric-accessible-graphics/
‚îú‚îÄ‚îÄ src/fabric_access/           # Main package
‚îÇ   ‚îú‚îÄ‚îÄ cli.py                   # Click-based CLI (image-to-piaf, batch, list-presets, info, version)
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ processor.py         # Image processing (load, convert, enhance, threshold, density, scaling)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ contrast.py          # S-curve, CLAHE, auto-contrast, histogram equalization
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ braille_converter.py # Braille translation, label placement, key generation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ label_scaler.py      # Label fit analysis for auto-scaling (NEW)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pdf_generator.py     # PDF generation with ReportLab, key pages
‚îÇ   ‚îú‚îÄ‚îÄ mcp_server/              # MCP server for Claude integration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ server.py            # FastMCP server entry point
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tools.py             # MCP tool implementations
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ standards_loader.py  # YAML configuration loader
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ presets.py           # Preset manager for common image types
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logger.py            # Screen-reader friendly logging
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ validators.py        # Input validation
‚îÇ   ‚îî‚îÄ‚îÄ data/
‚îÇ       ‚îú‚îÄ‚îÄ tactile_standards.yaml  # Tactile graphics configuration
‚îÇ       ‚îú‚îÄ‚îÄ presets.yaml         # 10 preset configurations
‚îÇ       ‚îî‚îÄ‚îÄ fonts/
‚îÇ           ‚îî‚îÄ‚îÄ DejaVuSans.ttf   # Bundled Braille-compatible font
‚îú‚îÄ‚îÄ docs/                        # Documentation
‚îÇ   ‚îú‚îÄ‚îÄ guides/                  # User guides and quickstarts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MCP_SETUP.md         # MCP server configuration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WALKTHROUGH.md       # Detailed user guide
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WINDOWS-QUICKSTART.md
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ TEXT_DETECTION_QUICKSTART.md
‚îÇ   ‚îú‚îÄ‚îÄ development/             # Development and implementation docs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BRAILLE_STATUS.md    # Current Braille feature status
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LIBLOUIS_INTEGRATION_COMPLETE.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TEXT_DETECTION_IMPLEMENTATION.md  # Renamed from IMPLEMENTATION_SUMMARY
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WHITEOUT_FIX_SUMMARY.md  # Includes quick reference
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ TACTILE_GUIDELINES_PROJECT_STATUS.md
‚îÇ   ‚îú‚îÄ‚îÄ BRAILLE_MODULE.md        # Primary Braille reference (includes workflow)
‚îÇ   ‚îî‚îÄ‚îÄ TEXT-AND-BRAILLE-GUIDE.md
‚îú‚îÄ‚îÄ samples/                     # Sample input images for testing
‚îú‚îÄ‚îÄ outputs/                     # Generated outputs
‚îú‚îÄ‚îÄ scripts/                     # Utility scripts
‚îú‚îÄ‚îÄ bin/
‚îÇ   ‚îî‚îÄ‚îÄ fabric-access            # Executable entry point
‚îú‚îÄ‚îÄ tests/                       # Unit tests
‚îú‚îÄ‚îÄ examples/                    # Example usage
‚îú‚îÄ‚îÄ patterns/                    # Pattern definitions (hatching system)
‚îú‚îÄ‚îÄ venv/                        # Virtual environment (not in git)
‚îú‚îÄ‚îÄ setup.py                     # Package setup
‚îú‚îÄ‚îÄ requirements.txt             # Dependencies
‚îú‚îÄ‚îÄ README.md                    # Installation and overview
‚îú‚îÄ‚îÄ .claude.md                   # This file - AI context
‚îú‚îÄ‚îÄ run.sh                       # WSL startup script
‚îî‚îÄ‚îÄ run.ps1                      # PowerShell startup script
```

## Technical Stack

- **Python**: 3.8+ (tested on 3.12)
- **CLI Framework**: Click (screen-reader friendly)
- **Image Processing**: Pillow (PIL), NumPy
- **Pattern Detection**: OpenCV (for Phase 2)
- **PDF Generation**: ReportLab
- **Configuration**: PyYAML

## Key Technical Details

### Image Processing Pipeline (Phase 2)

1. **Load**: PIL Image.open() with format validation
2. **Convert**: RGB ‚Üí Grayscale (mode 'L')
3. **Enhance** (NEW - Optional): Apply contrast enhancement
   - S-curve: Sigmoid-based midtone contrast boost (adjustable strength 0.0-2.0)
   - Auto-contrast: Histogram stretching to full 0-255 range
   - CLAHE: Adaptive local contrast enhancement (good for photos)
   - Histogram equalization: Global contrast normalization
4. **Threshold**: Apply threshold to create 1-bit B&W (mode '1')
   - Pixels above threshold ‚Üí white
   - Pixels below threshold ‚Üí black
5. **Density Check**: Count black pixels / total pixels
   - Target: <30% (optimal)
   - Warning: 40-45%
   - Error: >45%
6. **PDF Generation**: ReportLab at 300 DPI with metadata

### Threshold Values Guide

- **80-120**: More white, less black (good for dark images)
- **128**: Default balanced conversion
- **140-180**: More black, less white (good for light sketches/CAD)

### Density Management

PIAF paper swells when heated black areas expand. Too much black causes:
- Excessive swelling that obscures detail
- Paper curling
- Overlap between nearby elements

The toolkit automatically checks and warns about density issues.

## Phase 2 Features - Usage Guide

### S-Curve Enhancement

Like Photoshop curves, S-curve boosts midtone contrast:
```bash
# Standard S-curve
fabric-access image-to-piaf plan.jpg --enhance s_curve --verbose

# Stronger enhancement for faint images
fabric-access image-to-piaf sketch.jpg --enhance s_curve --enhance-strength 1.5

# Subtle enhancement
fabric-access image-to-piaf drawing.jpg --enhance s_curve --enhance-strength 0.7
```

When to use:
- **S-curve**: Most architectural drawings, clean sketches (RECOMMENDED)
- **Auto-contrast**: Scanned images with limited tonal range
- **CLAHE**: Photographs with uneven lighting
- **Histogram**: Very dark or very light images needing aggressive adjustment

### Preset System

Presets provide optimized settings for common image types:

```bash
# List all available presets
fabric-access list-presets

# Use a preset
fabric-access image-to-piaf floor-plan.jpg --preset floor_plan --verbose
fabric-access image-to-piaf sketch.png --preset sketch
fabric-access image-to-piaf photo.jpg --preset photograph
```

Available presets:
- `floor_plan` - Threshold 140, S-curve 1.0, letter paper
- `sketch` - Threshold 130, S-curve 1.3, letter paper
- `photograph` - Threshold 120, CLAHE, letter paper, lower density target
- `elevation` - Threshold 135, S-curve 1.0, letter paper
- `section` - Threshold 145, S-curve 1.2, letter paper
- `technical_drawing` - Threshold 150, no enhancement, letter paper
- `diagram` - Threshold 135, auto-contrast, letter paper
- `site_plan` - Threshold 140, S-curve 1.0, tabloid paper
- `detail_drawing` - Threshold 145, S-curve 1.1, letter paper
- `presentation` - Threshold 125, CLAHE, tabloid paper

Presets can be overridden:
```bash
# Use floor_plan preset but override threshold
fabric-access image-to-piaf plan.jpg --preset floor_plan --threshold 150
```

### Batch Processing

Process multiple files at once:

```bash
# Basic batch with preset
fabric-access batch ./drawings ./output --preset floor_plan

# Recursive (process subdirectories)
fabric-access batch ./all-drawings ./output --preset floor_plan --recursive

# Custom settings for all files
fabric-access batch ./sketches ./output --threshold 130 --enhance s_curve

# Specific file patterns
fabric-access batch ./images ./output --pattern "*.png,*.jpg" --preset photograph

# Verbose output for each file
fabric-access batch ./plans ./output --preset floor_plan --verbose
```

Output:
- Creates output directory if it doesn't exist
- Names files: `{original_name}_piaf.pdf`
- Shows progress counter: `[2/10] Processing: plan2.jpg`
- Reports summary: successful/failed counts
- Lists any failed files with error messages

## Code Style and Conventions

### Accessibility Requirements

1. **No Visual-Only Output**
   - No emojis, unicode symbols, or ASCII art
   - No color-based status (use text: "Error:", "Success:", etc.)
   - No tables or columnar layouts (use linear lists)

2. **Message Format**
   ```
   [STATUS]: [Clear description]

   Examples:
   Loading: floor-plan.jpg
   Processing: Converting to grayscale
   Success: PDF saved to output.pdf
   Error: File not found
   Solution: Check the file path and try again
   ```

3. **Progressive Disclosure**
   - Basic mode: Only essential messages
   - Verbose mode: Detailed step-by-step
   - Interactive mode: Prompts and confirmations

### Code Organization

- **Separation of Concerns**: CLI, processing, generation, config are separate modules
- **Error Handling**: Custom exceptions with descriptive messages
- **Logging**: Centralized through AccessibleLogger
- **Validation**: All inputs validated before processing
- **Configuration**: YAML-based, human-editable

### Testing Approach

Current: Manual testing with sample images
Future: Unit tests for each module, integration tests for full pipeline

## Common Development Tasks

### Adding a New Feature

1. Update the plan file (see `~/.claude/plans/peppy-meandering-grove.md`)
2. Implement the feature in appropriate module
3. Update CLI if user-facing
4. Update configuration if configurable
5. Test with sample images
6. Update README.md and WALKTHROUGH.md
7. Consider accessibility impact

### Modifying Tactile Standards

Edit: `src/fabric_access/data/tactile_standards.yaml`

Changes automatically loaded on next run (or use `--config` to specify custom file).

### Debugging

Use verbose mode to see detailed processing:
```bash
fabric-access image-to-piaf test.jpg --verbose
```

Check processing at each stage:
- Image loaded correctly?
- Grayscale conversion successful?
- Threshold applied?
- Density calculated?
- PDF generated?

### Common Issues

**Module not found errors:**
```bash
source venv/bin/activate
pip install -r requirements.txt
```

**Image processing fails:**
- Check file format is supported
- Check file is not corrupted
- Try with simpler test image

**PDF generation fails:**
- Check output directory is writable
- Check disk space
- Check PDF name has .pdf extension

## Future Development Roadmap

### Phase 2: Advanced Processing (Next)

**Priority Features:**
1. Image tiling system for large drawings
   - Split into overlapping tiles
   - Add registration marks
   - Multi-page PDF output
2. Pattern detection
   - Detect horizontal/vertical lines (brick, siding)
   - Detect crosshatch (earth fill)
   - Detect stipple (concrete)
3. Pattern simplification
   - Reduce line density
   - Increase line weight
   - Convert complex patterns to simpler ones
4. Preset system
   - floor_plan preset
   - elevation preset
   - photograph preset
   - sketch preset

**Implementation Files:**
- `src/fabric_access/core/tiler.py`
- `src/fabric_access/core/contrast.py`
- `src/fabric_access/core/pattern_detector.py`
- `src/fabric_access/data/presets.yaml`
- `src/fabric_access/config/presets.py`

### Phase 3: Integration (Later)

- Fabric pattern structure (for AI tool chaining)
- Advanced interactive mode
- Metadata export/import for chaining
- Enhanced PDF features (Braille labels, QR codes)

## Important Context for AI Assistants

### When Working on This Project

1. **Always consider screen-reader users**: Test that changes are accessible
2. **Preserve message format**: Keep the `[STATUS]: [Message]` pattern
3. **No emojis ever**: The user cannot see them
4. **Validate all inputs**: Prevent confusing errors
5. **Provide solutions**: Every error should suggest how to fix it
6. **Maintain verbosity levels**: Respect --verbose flag
7. **Keep it simple**: Avoid over-engineering for hypothetical features

### Testing Changes

Always test with:
```bash
source venv/bin/activate
fabric-access image-to-piaf test-image.png --verbose
```

Create simple test images with PIL if needed.

### User's Environment

- **OS**: Windows with WSL2 (Linux subsystem)
- **Python**: 3.12
- **Screen Reader**: Likely NVDA or JAWS (design for both)
- **Use Case**: Architecture student converting course materials and design work

## References

- **PIAF Machine**: Picture In A Flash - creates raised tactile graphics
- **Tactile Graphics Standards**: Based on accessibility best practices for blind users
- **Fabric**: The larger ecosystem this may integrate with (pattern-based AI tools)

## Questions or Unclear Requirements?

When in doubt:
1. Prioritize accessibility
2. Keep it simple
3. Ask the user for clarification
4. Test with verbose output
5. Provide clear error messages

## Version History

- **v0.1.0** (Current): Phase 1 MVP - Basic conversion functionality
- **v0.2.0** (Planned): Phase 2 - Tiling and pattern detection
- **v0.3.0** (Future): Phase 3 - Advanced integration

## Recent Session Work

### Dec 20, 2025 - Text Whiteout & Overlap Prevention

#### Session 3: Text Whiteout Feature
- **Problem:** Braille labels overlay on original text; when PIAFed, both swell and obscure each other
- **Solution:** White out original text regions before adding Braille
- **Implementation:**
  - Added `whiteout_text_regions()` method to `processor.py`
  - Uses exact OCR bounding boxes from DetectedText objects
  - Whiteout happens after Braille labels are created, before PDF generation
  - Configurable padding (default: 5 pixels)
- **Key insight:** Must white out the **original text location** (from OCR), not the Braille label position
- **Config:** `tactile_standards.yaml` - `whiteout_original_text: true`, `whiteout_padding: 5`

#### Session 4: Braille Overlap Prevention
- **Problem:** Multiple Braille labels overlapping, making them unreadable when PIAFed
- **Solution:** Automatic repositioning of overlapping labels
- **Implementation:**
  - Added `_would_overlap()` method to check bounding box collisions
  - Added `_find_clear_position()` method - tries: original ‚Üí below ‚Üí above ‚Üí right ‚Üí left
  - Modified `create_braille_labels()` to track placed boxes and reposition overlapping labels
  - Labels that can't be repositioned are skipped with a log message
- **Results:**
  - samples/plan_test.jpg: 7 labels repositioned, 5 skipped (no clear position)
  - ANNEX plan: 32 labels repositioned, 1 skipped

#### Key Files Modified (Dec 20)
1. `src/fabric_access/core/processor.py` - Added `whiteout_text_regions()` method
2. `src/fabric_access/core/braille_converter.py` - Added overlap prevention with repositioning
3. `src/fabric_access/cli.py` - Integrated whiteout call after Braille conversion
4. `src/fabric_access/data/tactile_standards.yaml` - Added whiteout config options

### Dec 17, 2025 - Liblouis & Font Fixes

#### Session 1: Liblouis Integration
- **Problem:** Dummy `louis` package, no real Braille translation
- **Solution:** Created symlink to system liblouis 3.29.0
  ```bash
  ln -s /usr/lib/python3/dist-packages/louis venv/lib/python3.12/site-packages/louis
  ```
- **Result:** Real Grade 1 & 2 Braille working with Unicode output

#### Session 2: Font Rendering Fix
- **Problem:** Braille characters showed as black squares in PDF output
- **Solution:** Modified `pdf_generator.py` to register DejaVu Sans font properly
- **Result:** Braille characters render as proper dots (‚††‚†Ö‚†ä‚†û‚†â‚†ì‚†ë‚†ù)

### Test Files
- `outputs/visualizations/example-visualization.png` - Shows 3-step process: text ‚Üí bounding boxes ‚Üí Braille
- `outputs/test-results/test-no-overlap.pdf` - Test output with overlap prevention
- `outputs/test-results/test-annex-no-overlap.pdf` - Large image test with 184 Braille labels

### Jan 3, 2026 - Hatching Pattern System & Project Reorganization

#### Hatching Pattern System for Architectural Materials
Created standardized tactile hatching patterns for structures coursework:

**Files Created in `/patterns/references/`:**
- `HATCH_SYSTEM.md` - Tactile pattern definitions (6 patterns) with BANA compliance
- `TRADITIONAL_HATCHING.md` - Standard architectural hatching conventions (13+ materials)
- `generate_test_patterns.py` - Script to generate test PDFs
- `HATCH_TEST_SHEET_TACTILE.pdf` - 6 tactile patterns with Braille labels
- `HATCH_TEST_SHEET_TRADITIONAL.pdf` - Traditional architectural patterns
- `HATCH_COMPARISON.pdf` - Side-by-side comparison

**6-Pattern Tactile System (Structures-Focused):**
| Pattern | Material | Specification |
|---------|----------|---------------|
| P1: Solid | Steel | Solid black fill |
| P2: Stipple | Concrete | 3mm dot spacing, 1.5mm diameter |
| P3: Diagonal | Masonry | 45-degree lines, 4mm spacing |
| P4: Horizontal | Wood | Horizontal lines, 4mm spacing |
| P5: Crosshatch | Earth/Fill | Grid, 10mm spacing |
| P6: Vertical | Glass | Vertical lines, 4mm spacing |

**Key Constraints (BANA Guidelines):**
- Maximum 4-6 textures per graphic
- Minimum 3mm spacing between elements
- Line-based patterns should NOT be adjacent to each other
- Solid and stipple CAN be adjacent to any pattern

#### Project Folder Reorganization
Cleaned root directory from 58 files to 6 essential files.

**New Structure:**
```
docs/guides/           - User guides (WALKTHROUGH, QUICKSTART docs)
docs/development/      - Implementation notes, status docs
docs/references/       - BANA standards PDF
samples/               - Input test images
outputs/test-results/  - Generated test PDFs (~48 files)
outputs/visualizations/- Debug images
scripts/               - Utility scripts
patterns/references/   - NEW: Hatching pattern system
```

**Next Steps:**
1. Print `HATCH_TEST_SHEET_TACTILE.pdf` on PIAF machine
2. Test with student - can all 6 patterns be distinguished?
3. Adjust spacing/density based on feedback
4. Update `floor-plans.md` to reference the finalized system

### Jan 5, 2026 - MCP Server for AI Integration

Added an MCP (Model Context Protocol) server that exposes the fabric-access tools to Claude, enabling natural language interaction for image conversion.

**Files Created:**
- `src/fabric_access/mcp_server/__init__.py` - Package init
- `src/fabric_access/mcp_server/server.py` - FastMCP server entry point
- `src/fabric_access/mcp_server/tools.py` - Tool implementations
- `docs/guides/MCP_SETUP.md` - Configuration guide

**MCP Tools Available:**
| Tool | Purpose |
|------|---------|
| `convert_to_tactile` | Convert image to PIAF-ready PDF |
| `list_presets` | List available conversion presets |
| `analyze_image` | Pre-flight check with recommendations |
| `describe_image` | Generate detailed accessibility descriptions (Arch-Alt-Text) |
| `extract_text_with_vision` | LLM-based OCR using Claude's vision (NEW) |

**MCP Resources Available:**
| Resource | Purpose |
|----------|---------|
| `arch-alt-text://prompt` | System prompt for image descriptions |
| `ocr-extraction://prompt` | System prompt for vision-based text extraction (NEW) |

**Usage:**
Student tells Claude: "Convert this floor plan to tactile"
Claude uses MCP tools automatically and responds with results.

**Configuration:**
Add to Claude Code MCP settings:
```json
{
  "mcpServers": {
    "fabric-access": {
      "command": "/mnt/c/Users/ethan/fabric-accessible-graphics/venv/bin/fabric-access-mcp"
    }
  }
}
```

See `docs/guides/MCP_SETUP.md` for complete setup instructions.

### Jan 5, 2026 (Session 2) - MCP Server Fixes & Improvements

Fixed four critical issues identified during MCP server testing:

#### Issue 1: Tile Overlap Default Changed to 0%
- **Problem:** 10% default overlap caused alignment issues with printer margins
- **Solution:** Changed default from 0.1 to 0.0 across all entry points
- **Files Modified:**
  - `src/fabric_access/core/tiler.py` - Line 30: `overlap_percentage: float = 0.0`
  - `src/fabric_access/cli.py` - Line 102: `default=0.0`
  - `src/fabric_access/mcp_server/tools.py` - Added `tile_overlap: float = 0.0` parameter

#### Issue 2: Dual-Text Rendering (Braille + Print Stacked)
- **Problem:** Assembly instructions, page labels only in print - blind users couldn't read them
- **Solution:** All generated text now renders in dual format (Braille above, print below)
- **Files Modified:**
  - `src/fabric_access/core/pdf_generator.py`:
    - Added `BrailleConverter` import
    - Added `_internal_braille_converter` instance in `__init__()`
    - Added `_create_internal_braille_converter()` method
    - Updated `add_text_page()` - Assembly instructions dual-rendered
    - Updated `add_tile_label()` - Page labels dual-rendered

#### Issue 3: LLM Vision OCR Tool
- **Problem:** Tesseract OCR misses handwritten text, small text, rotated text
- **Solution:** New MCP tool that uses Claude's vision for text extraction
- **Files Modified:**
  - `src/fabric_access/mcp_server/tools.py` - Added `extract_text_with_vision()` tool
  - `src/fabric_access/mcp_server/server.py`:
    - Registered new tool
    - Added `ocr-extraction://prompt` resource with detailed extraction guidance
- **Usage:** Call `extract_text_with_vision`, read `ocr-extraction://prompt`, view image, return JSON array of detected text

#### Issue 4: Braille Font Not Rendering (White Boxes)
- **Problem:** DejaVu Sans font not found, silent fallback to Helvetica (no Braille glyphs)
- **Solution:** Bundled font with package, removed silent fallback
- **Files Created:**
  - `src/fabric_access/data/fonts/DejaVuSans.ttf` - Bundled font file
- **Files Modified:**
  - `src/fabric_access/core/pdf_generator.py`:
    - Added `_braille_font_available` flag
    - Updated `_register_braille_font()` to check bundled font first
    - Updated `_add_braille_labels()` to check flag, error instead of silent fallback

#### Image Description Machine Integration
- **Status:** Integrated into MCP server via `describe_image` tool and `arch-alt-text://prompt` resource
- **Location:** `patterns/image_description_machine/image_description_machine.md`
- **How it works:** Tool validates image, returns path + instructions. Claude reads the resource prompt, views the image with vision, and generates Macro/Meso/Micro description.
- **No API key needed:** Uses the active Claude session's vision capability instead of external API calls

#### Testing Results
- Small image (plan_test.jpg): 17 Braille labels, successful conversion
- Large image (ANNEX plan): 185 Braille labels, tiled with 0% overlap, successful conversion

### Jan 5, 2026 (Session 3) - MCP Connection & Hybrid OCR Fixes

#### Issue 1: MCP Server Not Connecting
- **Problem:** Claude Code wasn't connecting to the fabric-access MCP server
- **Cause:** Missing `.mcp.json` configuration file
- **Fix:** Created `/home/ethan/.claude/.mcp.json`:
```json
{
  "mcpServers": {
    "fabric-access": {
      "command": "/mnt/c/Users/ethan/fabric-accessible-graphics/venv/bin/fabric-access-mcp"
    }
  }
}
```

#### Issue 2: Syntax Error in tools.py
- **Problem:** `tools.py:786` had invalid backslash escaping in f-string
- **Fix:** Changed `10\\'-6\"` to `10 feet-6 inches`

#### Issue 3: Parameter Type Mismatch (claude_text_json)
- **Problem:** `claude_text_json` parameter expected `str` but Claude passes a list
- **Error:** `Input should be a valid string [type=string_type, input_value=[...], input_type=list]`
- **Fix** in `tools.py`:
  - Line 11: Added `Union, List, Dict, Any` to imports
  - Line 67: Changed type to `Optional[Union[str, List[Dict[str, Any]]]]`
  - Lines 226-230: Added type normalization to accept both string and list

### Jan 7, 2026 - Auto-Scaling and Abbreviation Key

#### The Problem: Braille Labels Too Large
Braille has a fixed physical size that cannot be reduced. When text is detected and converted to Braille, the resulting labels are often significantly larger than the original text, causing:
- Labels overlapping with drawing elements
- Labels extending off the page
- Labels obscuring important details

Two separate issues:
1. **Scale**: Braille cells are physically larger than print text
2. **Length**: Braille translations can be longer than original text (especially Grade 2 contractions)

#### Solution 1: Auto-Scaling
Automatically enlarge the image so Braille labels fit within original text bounding boxes.

**How it works:**
1. After text detection, analyze each label's Braille width vs original text box width
2. Calculate recommended scale percentage (e.g., 180% if largest label is 1.8x original)
3. Scale image up to `max_scale_factor` (default 200%)
4. Scale detected text coordinates proportionally
5. Tile across multiple pages if scaled image exceeds paper size

**New file:** `src/fabric_access/core/label_scaler.py`
- `analyze_label_fit()` - Returns fits, needs_key, fit_ratios, recommended_scale

**Modified files:**
- `processor.py` - Added `scale_image()`, `scale_detected_texts()` methods
- `tools.py` - Added auto-scaling logic and new parameters

#### Solution 2: Abbreviation Key
Labels that don't fit even after scaling get assigned letter codes (A, B, C...) with a key page.

**How it works:**
1. Labels that still don't fit after scaling get letters: A=Kitchen, B=Bathroom
2. Key page generated at beginning of PDF
3. Key shows both Braille and print: `‚†Å = ‚†Ö‚†ä‚†û‚†â‚†ì‚†ë‚†ù (Kitchen)`

**Modified files:**
- `braille_converter.py` - Added `KeyEntry` dataclass, `_get_next_key_letter()`, updated `create_braille_labels()`
- `pdf_generator.py` - Added `add_abbreviation_key_page()`, updated `generate()` and `generate_with_tiling()`

#### New MCP Parameters
```python
scale_percent: Optional[float] = None    # Manual scale override
auto_scale: bool = True                  # Enable auto-scaling
max_scale_factor: float = 2.0            # Maximum scale (200%)
use_abbreviation_key: bool = True        # Enable abbreviation key
force_abbreviation_key: bool = False     # Abbreviate ALL labels
```

#### Testing Results
- plan_test.jpg: "Kitchen" and "Bathroom" abbreviated to A and B, key page generated
- Short labels like "OK" kept full Braille

---

## Future Enhancements

### Planned Features
1. **Grid Overlay** - More precise text positioning with cell references (C4)
2. **Rotated Braille** - Render Braille at matching angles for sideways text
3. **Multi-page PDF Combining** - Combine pages with shared context
4. **Quality Assessment Loop** - Claude compares original vs processed image

---

## Last Updated

**2026-01-07** - Added auto-scaling and abbreviation key features. Cleaned up redundant documentation files.
